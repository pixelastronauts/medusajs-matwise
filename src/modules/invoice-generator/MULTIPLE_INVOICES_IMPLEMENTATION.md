# Multiple Invoices & Credit Notes Implementation

## Overview
This implementation adds support for multiple invoices per order, including automatic generation of credit notes (credit nota) when refunds are processed.

## Changes Made

### 1. Invoice Model Updates
- **File**: `models/invoice.ts`
- Changed from `InvoiceStatus` (LATEST/STALE) to `InvoiceType` (INVOICE/CREDIT_NOTE)
- Added `type` field to differentiate between invoices and credit notes
- Added `refund_id` field to link credit notes to their refund
- Added `amount` field to track invoice/credit note amounts

### 2. Database Migration
- **File**: `migrations/Migration20251127000000.ts`
- Migrates existing invoices to new schema
- Adds `type`, `refund_id`, and `amount` columns
- Removes old `status` column
- All existing invoices are set to type `invoice`

### 3. Service Updates
- **File**: `service.ts`
- Updated to use `InvoiceType` instead of `InvoiceStatus`
- Modified PDF generation to support credit notes
- Credit notes show "CREDIT NOTE" as title instead of "INVOICE"
- Credit note IDs are prefixed with "CN-" instead of "INV-"

### 4. Workflows

#### Generate Invoice PDF Workflow
- **File**: `workflows/generate-invoice-pdf.ts`
- Updated to pass order total as invoice amount
- Creates regular invoices for orders

#### Generate Credit Note PDF Workflow (NEW)
- **File**: `workflows/generate-credit-note-pdf.ts`
- New workflow specifically for generating credit notes
- Takes `order_id`, `refund_id`, and `amount` as input
- Creates credit note invoices linked to refunds

### 5. Workflow Steps
- **File**: `workflows/steps/get-order-invoice.ts`
- Updated to support both invoice types
- Can create credit notes linked to specific refunds
- Prevents duplicate credit notes for the same refund
- Prevents duplicate invoices for the same order

### 6. Event Subscriber (NEW)
- **File**: `subscribers/refund-created.ts`
- Automatically generates credit notes when refunds are created
- Listens to `payment.refund_created` event
- Calls credit note generation workflow

### 7. API Routes

#### List All Invoices
- **Files**: 
  - `api/admin/orders/[id]/invoices/route.ts`
  - `api/store/orders/[id]/invoices/route.ts`
- Changed from downloading single invoice to listing all invoices
- Returns array of invoices with metadata (type, amount, date, etc.)
- Sorted by created_at descending (newest first)

#### Download Specific Invoice (NEW)
- **Files**:
  - `api/admin/orders/[id]/invoices/[invoice_id]/route.ts`
  - `api/store/orders/[id]/invoices/[invoice_id]/route.ts`
- New routes to download specific invoice or credit note PDFs
- Automatically determines which workflow to use based on invoice type
- Generates appropriate filename based on document type

### 8. Admin Widget
- **File**: `admin/widgets/order-invoice.tsx`
- Completely redesigned to show all invoices in a table
- Displays invoice number, type (with badge), date, and amount
- Credit notes show orange badge, invoices show green badge
- Each invoice has individual download button
- Shows credit note amounts with minus sign
- Empty state when no invoices exist

## Usage

### Automatic Invoice Generation
When an order is placed, an invoice is automatically generated by the `order-placed` subscriber.

### Automatic Credit Note Generation
When a refund is processed, a credit note is automatically generated by the `refund-created` subscriber.

### Manual Access

#### Admin Panel
Navigate to any order details page. The "Invoices & Credit Notes" widget shows all documents for that order.

#### API Access

**List all invoices for an order:**
```
GET /admin/orders/{order_id}/invoices
GET /store/orders/{order_id}/invoices
```

**Download specific invoice:**
```
GET /admin/orders/{order_id}/invoices/{invoice_id}
GET /store/orders/{order_id}/invoices/{invoice_id}
```

## Invoice Numbering

- **Regular Invoices**: `INV-000001`, `INV-000002`, etc.
- **Credit Notes**: `CN-000001`, `CN-000002`, etc.

Both use the same `display_id` sequence but different prefixes.

## Database Schema

```sql
CREATE TABLE invoice (
  id TEXT PRIMARY KEY,
  display_id SERIAL,
  order_id TEXT NOT NULL,
  type TEXT CHECK (type IN ('invoice', 'credit_note')) NOT NULL DEFAULT 'invoice',
  refund_id TEXT NULL,
  amount NUMERIC NOT NULL,
  pdfContent JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at TIMESTAMPTZ NULL
);
```

## Migration Instructions

1. **Run the migration**:
   ```bash
   npm run db:migrate
   ```

2. **Existing invoices** will automatically be converted to the new schema with type `invoice`

3. **No data loss** - all existing invoice data is preserved

## Testing

1. Place a test order - verify invoice is generated
2. Process a refund - verify credit note is generated
3. Check order details page - verify both documents appear in the widget
4. Download both documents - verify they have appropriate titles and numbering
5. Check API endpoints - verify they return correct data

## Notes

- Credit notes duplicate the order items from the original invoice
- Credit notes reference the original order, not a modified version
- Multiple credit notes can exist for the same order if multiple refunds occur
- The invoice widget only appears on order detail pages
- All invoices and credit notes are stored permanently (soft delete)


